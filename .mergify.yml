# =================================================================================================================================
# Copyright (c) RapidField LLC. Licensed under the MIT License. See LICENSE.txt in the project root for license information.
# =================================================================================================================================
# This file defines rules which govern the behavior of the Mergify bot when evaluating pull requests.
# ---------------------------------------------------------------------------------------------------------------------------------
pull_request_rules:
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label new pull requests.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Stage0-New
  - label!=Stage1-UnderReview
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label!=Stage3-InProgress
  - label!=Stage4-Complete
  # ----------------------------------------------------------------
  - label!=Verdict-Pending
  - label!=Verdict-Relayed
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage0-New
      - Verdict-Pending
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label uncategorized pull requests.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Category-Defect
  - label!=Category-Feature
  - label!=Category-Maintenance
  - label!=Category-ProductionRelease
  - label!=Category-Question
  - label!=Category-Uncategorized
  # ----------------------------------------------------------------
  - label=Stage0-New
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Category-Uncategorized
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label bot-sourced pull requests.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^dependabot.*$)|(^mergify.*$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Source-Bot
  - label!=Source-Maintainer
  - label!=Source-User
  # ----------------------------------------------------------------
  - label=Stage0-New
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Source-Bot
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label maintainer-sourced pull requests.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^adamjstone$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Source-Bot
  - label!=Source-Maintainer
  - label!=Source-User
  # ----------------------------------------------------------------
  - label=Stage0-New
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Source-Maintainer
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label user-sourced pull requests.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Source-Bot
  - label!=Source-Maintainer
  - label!=Source-User
  # ----------------------------------------------------------------
  - label!=Stage0-New
  - label=Stage1-UnderReview
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Source-User
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label dependency management pull requests.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^dependabot.*$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Subcategory-Dependencies
  # ----------------------------------------------------------------
  - label!=Tag-AddReleaseNote
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Subcategory-Dependencies
      - Tag-AddReleaseNote
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label maintenance pull requests.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^dependabot.*$)|(^mergify.*$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Category-Maintenance
  - label=Category-Uncategorized
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Category-Maintenance
      remove:
      - Category-Uncategorized
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label under-review pull requests.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Category-Uncategorized
  # ----------------------------------------------------------------
  - label=Stage0-New
  - label!=Stage1-UnderReview
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  # ----------------------------------------------------------------
  - status-success=CodeFactor
  - status-success=continuous-integration/appveyor/branch
  - status-success=continuous-integration/appveyor/pr
  - status-success=Summary
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage1-UnderReview
      remove:
      - Stage0-New
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label accepted maintenance pull requests.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label=Category-Maintenance
  # ----------------------------------------------------------------
  - label=Stage1-UnderReview
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  # ----------------------------------------------------------------
  - status-success=CodeFactor
  - status-success=continuous-integration/appveyor/branch
  - status-success=continuous-integration/appveyor/pr
  - status-success=Summary
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage2-Accepted
      remove:
      - Stage1-UnderReview
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label rejected pull requests.
  conditions:
  # ----------------------------------------------------------------
  - closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage2-Rejected
      remove:
      - Stage0-New
      - Stage1-UnderReview
      - Stage2-Accepted
      - Stage2-Deferred
      - Stage3-InProgress
      - Stage4-Complete
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label in-progress branches when the author is trusted.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^adamjstone$)|(^dependabot.*$)|(^mergify.*$)
  - base~=(^master$)|(^develop$)|(^release\/(.+)$)|(^feature\/(.+)$)|(^hotfix\/(.+)$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label!=Stage3-InProgress
  # ----------------------------------------------------------------
  - status-success=CodeFactor
  - status-success=continuous-integration/appveyor/branch
  - status-success=continuous-integration/appveyor/pr
  - status-success=Summary
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage3-InProgress
      remove:
      - Stage2-Accepted
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label in-progress branches when reviewed and approved.
  conditions:
  # ----------------------------------------------------------------
  - "#approved-reviews-by>=1"
  - base~=(^feature\/(.+)$)|(^hotfix\/(.+)$)
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label!=Stage3-InProgress
  # ----------------------------------------------------------------
  - status-success=CodeFactor
  - status-success=continuous-integration/appveyor/branch
  - status-success=continuous-integration/appveyor/pr
  - status-success=Summary
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage3-InProgress
      remove:
      - Stage2-Accepted
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label completed pull requests.
  conditions:
  # ----------------------------------------------------------------
  - closed
  - merged
  # ----------------------------------------------------------------
  - label!=Stage4-Complete
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Stage4-Complete
      remove:
      - Stage0-New
      - Stage1-UnderReview
      - Stage2-Accepted
      - Stage2-Deferred
      - Stage2-Rejected
      - Stage3-InProgress
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Label completed backmerge pull requests.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^mergify.*$)
  - title~=(^.*\(bp .*\)$)
  # ----------------------------------------------------------------
  - closed
  - merged
  # ----------------------------------------------------------------
  - label=Stage4-Complete
  # ----------------------------------------------------------------
  - label=Verdict-Pending
  - label!=Verdict-Relayed
  # ----------------------------------------------------------------
  actions:
    label:
      add:
      - Verdict-Relayed
      remove:
      - Verdict-Pending
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Merge eligible branches.
  conditions:
  # ----------------------------------------------------------------
  - -closed
  - -merged
  # ----------------------------------------------------------------
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label=Stage3-InProgress
  - label!=Stage4-Complete
  # ----------------------------------------------------------------
  - status-success=CodeFactor
  - status-success=continuous-integration/appveyor/branch
  - status-success=continuous-integration/appveyor/pr
  - status-success=Summary
  # ----------------------------------------------------------------
  actions:
    merge:
      method: merge
      strict: smart
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Backmerge from master when the author is trusted.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^adamjstone$)|(^dependabot.*$)|(^mergify.*$)
  - base=master
  # ----------------------------------------------------------------
  - closed
  - merged
  # ----------------------------------------------------------------
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label!=Stage3-InProgress
  - label=Stage4-Complete
  # ----------------------------------------------------------------
  - label!=Tag-Backmerged
  # ----------------------------------------------------------------
  actions:
    backport:
      branches:
      # ----------------------------------------------------------------
      - develop
      - release/v1.0.25-preview1
      - release/v1.0.26-preview1
      # ----------------------------------------------------------------
    label:
      add:
      - Tag-Backmerged
# ---------------------------------------------------------------------------------------------------------------------------------
- name: Backmerge from develop when the author is trusted.
  conditions:
  # ----------------------------------------------------------------
  - author~=(^adamjstone$)|(^dependabot.*$)|(^mergify.*$)
  - base=develop
  # ----------------------------------------------------------------
  - closed
  - merged
  # ----------------------------------------------------------------
  - label!=Stage2-Accepted
  - label!=Stage2-Deferred
  - label!=Stage2-Rejected
  - label!=Stage3-InProgress
  - label=Stage4-Complete
  # ----------------------------------------------------------------
  - label!=Tag-Backmerged
  # ----------------------------------------------------------------
  actions:
    backport:
      branches:
      # ----------------------------------------------------------------
      - feature/0007-rabbitmq-support
      - feature/0012-structuremap-support
      # ----------------------------------------------------------------
    label:
      add:
      - Tag-Backmerged
# ---------------------------------------------------------------------------------------------------------------------------------
